FROM mcr.microsoft.com/dotnet/sdk:7.0
ENV ASPNETCORE_ENVIRONMENT=Development

WORKDIR /source
COPY . .

RUN dotnet new tool-manifest || true
RUN dotnet tool install dotnet-reportgenerator-globaltool

RUN dotnet test --collect:"XPlat Code Coverage" ./src/Hive.Api.Tests -c Test --settings ./src/Hive.Api.Tests/runsettings.xml

RUN mkdir -p ./api-coverage/

WORKDIR /source/src/Hive.Api.Tests/TestResults

RUN mv **/coverage.opencover.xml /source/api-coverage/

WORKDIR /source

RUN mv /source/api-coverage/coverage.opencover.xml /source/api-coverage/api-coverage.opencover.xml

RUN dotnet reportgenerator "-reports:/source/api-coverage/api-coverage.opencover.xml" "-targetdir:/source/api-coverage/" -reporttypes:Html